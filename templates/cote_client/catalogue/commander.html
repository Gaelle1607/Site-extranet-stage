{% extends 'cote_client/base.html' %}
{% load l10n %}

{% block title %}Commander{% endblock %}

{% block content %}
<div class="passage-commande-container">
    <!-- En-tête -->
    <div class="passage-commande-header">
        <h2><i class="bi bi-file-earmark-text"></i> Passer commande</h2>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- Section informations client -->
        <div class="info-client-section">
            <div class="row gx-5 gy-3">
                {% comment %} Chaque champ est en lecture seule sauf la date de livraison {% endcomment %}
                <div class="col-lg-6">
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-building me-2"></i>Nom du client :
                        </label>
                        <div class="col-7">
                            <input type="text" value="{{ client.nom }}" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-info-circle me-2"></i>Complément :
                        </label>
                        <div class="col-7">
                            <input type="text" value="{{ client.complement }}" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-geo-alt me-2"></i>Adresse :
                        </label>
                        <div class="col-7">
                            <input type="text" value="{{ client.adresse }}" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-mailbox me-2"></i>Code postal :
                        </label>
                        <div class="col-7">
                            <input type="text" value="{{ client.code_postal }}" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-pin-map me-2"></i>Ville :
                        </label>
                        <div class="col-7">
                            <input type="text" value="{{ client.acheminement }}" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="row align-items-center mb-3">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-truck me-2"></i>Départ camions :
                        </label>
                        <div class="col-7">
                            <input type="date" id="date-depart-camions" name="date_depart_camions" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="row align-items-center">
                        <label class="col-5 col-form-label fw-bold">
                            <i class="bi bi-calendar-event me-2"></i>Date de livraison :
                        </label>
                        <div class="col-7">
                            <input type="date" id="date-livraison" name="date_livraison" class="form-control" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section produits -->
        <div class="produits-commande-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-box-seam me-2"></i>Sélection des produits</h4>
                <div class="d-flex gap-2 align-items-center">
                    <button type="button" id="vider-panier-btn" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> Vider la commande
                    </button>
                    <div class="position-relative" style="max-width: 300px;">
                        <input type="text" id="recherche-produit" class="form-control pe-5" placeholder="Rechercher un produit...">
                        <button type="button" id="effacer-recherche" class="btn btn-link position-absolute top-50 end-0 translate-middle-y text-muted" style="display:none;">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            {% if produits %}
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Produit</th>
                                <th class="text-end" style="width: 140px;">Prix HT</th>
                                <th class="text-center" style="width: 90px;">Qté</th>
                                <th class="text-end" style="width: 100px;">Sous-total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in produits %}
                            <tr class="produit-ligne">
                                <td class="produit-nom">{{ produit.nom }}</td>
                                <td class="text-end text-nowrap">
                                    <strong>{{ produit.prix|floatformat:2 }}</strong> €/{{ produit.unite }}
                                </td>
                                <td class="text-center">
                                    <input type="number"
                                           name="qte_{{ produit.reference }}"
                                           min="0"
                                           value="{{ produit.panier_qte }}"
                                           data-prix="{{ produit.prix|unlocalize }}"
                                           data-reference="{{ produit.reference }}"
                                           class="form-control form-control-sm quantite-commande-input text-center"
                                           style="width: 70px; margin: 0 auto;">
                                </td>
                                <td class="text-end fw-bold sous-total-ligne text-nowrap">0.00 €</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Total général -->
                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                    <span class="fw-bold h5 mb-0">
                        Total produits : <span id="total-quantite">0</span> articles
                    </span>
                    <div>
                        <span class="fw-bold h5 me-3">Total HT :</span>
                        <span class="fw-bold h4 mb-0" id="total-commande">0.00 €</span>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>Aucun produit disponible.
                </div>
            {% endif %}
        </div>

        <!-- Commentaires / instructions -->
        <div class="commentaire-section mt-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i> Commentaires / Instructions</h5>
                </div>
                <div class="card-body">
                    <textarea name="commentaires" class="form-control" rows="3" placeholder="Ajoutez vos instructions..."></textarea>
                </div>
            </div>
        </div>

        <!-- Bouton valider la commande -->
        <button type="submit" class="btn btn-valider-commande w-100 mt-4">
            <i class="bi bi-check2-circle"></i> Valider la commande
        </button>
    </form>
</div>

{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/commander.js' %}?v=7"></script>
{% endblock %}
