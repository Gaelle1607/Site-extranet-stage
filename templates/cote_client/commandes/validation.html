{% extends 'cote_client/base.html' %}

{% block title %}Validation de commande{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-check2-square"></i> Validation de commande</h2>

<form method="post" action="{% url 'commandes:valider' %}">
    {% csrf_token %}
    <input type="hidden" name="confirmer" value="1">
    <div class="row">

        <!-- Récapitulatif des produits -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Articles commandés</h5></div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <table class="table mb-0">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th>Produit</th>
                                <th class="text-center">Qté</th>
                                <th class="text-end">Prix unit. HT</th>
                                <th class="text-end">Total HT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ligne in lignes %}
                            <tr>
                                <td><strong>{{ ligne.nom }}</strong><br><small class="text-muted">{{ ligne.reference }}</small></td>
                                <td class="text-center">{{ ligne.quantite }}{% if ligne.unite %} {{ ligne.unite }}{% endif %}</td>
                                <td class="text-end">{{ ligne.prix|floatformat:2 }} €</td>
                                <td class="text-end">{{ ligne.total|floatformat:2 }} €</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Commentaires (affichage) -->
            {% if commentaires %}
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Commentaires</h5></div>
                <div class="card-body">
                    <p class="mb-0">{{ commentaires }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Récapitulatif côté droit -->
        <div class="col-md-4">
            <div class="card sticky-top" style="top:20px;">
                <div class="card-header bg-primary text-white"><h5 class="mb-0">Récapitulatif</h5></div>
                <div class="card-body">
                    {% if client %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Client</span><span class="fw-bold">{{ client.nom }}</span>
                    </div>
                    {% endif %}

                    {% if date_livraison %}
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="bi bi-calendar-event me-1"></i>Livraison</span>
                        <span class="fw-bold">{{ date_livraison|date:"d/m/Y" }}</span>
                    </div>
                    {% endif %}

                    {% if date_depart_camions %}
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="bi bi-truck me-1"></i>Départ camions</span>
                        <span class="fw-bold">{{ date_depart_camions|date:"d/m/Y" }}</span>
                    </div>
                    {% endif %}

                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Articles</span><span>{{ nombre_articles }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total HT</span><span class="fw-bold h4 mb-0 text-success">{{ total|floatformat:2 }} €</span>
                    </div>

                    <!-- Boutons valider / modifier panier -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-check2-circle me-2"></i>Confirmer la commande</button>
                        <a href="{% url 'commandes:panier' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Modifier le panier</a>
                    </div>

                    <p class="text-muted small text-center mt-3 mb-0">
                        En confirmant, votre commande sera envoyée.
                    </p>
                </div>
            </div>
        </div>

    </div>
</form>
{% endblock %}
