{% extends 'administration/base_admin.html' %}
{% load static %}

{% block title %}Modifier - {{ utilisateur.user.username }}{% endblock %}

{% block content %}
<h2><i class="bi bi-pencil-square"></i> Modifier l'utilisateur</h2>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-person-gear"></i> Informations du compte</h5>
    </div>
    <div class="card-body">
        <form method="post" id="form-modifier">
            {% csrf_token %}

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="username" class="form-label">Nom d'utilisateur</label>
                    <input type="text" class="form-control" id="username" name="username"
                           value="{{ utilisateur.user.username }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Adresse email</label>
                    <input type="email" class="form-control" id="email" name="email"
                           value="{{ utilisateur.user.email }}" required>
                </div>
            </div>

            <hr class="my-4">
            <h6 class="text-muted mb-3"><i class="bi bi-key"></i> Changer le mot de passe (optionnel)</h6>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nouveau_mdp" class="form-label">Nouveau mot de passe</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="nouveau_mdp" name="nouveau_mdp" minlength="4">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="nouveau_mdp">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <small class="text-muted">Laissez vide pour ne pas changer</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="confirm_mdp" class="form-label">Confirmer le mot de passe</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="confirm_mdp" name="confirm_mdp" minlength="4">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirm_mdp">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div id="mdp-error" class="invalid-feedback" style="display: none;">
                        Les mots de passe ne correspondent pas.
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Enregistrer les modifications
                </button>
                <a href="{% url 'administration:information_utilisateur' utilisateur.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'js/toggle-password.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-modifier');
    const nouveauMdp = document.getElementById('nouveau_mdp');
    const confirmMdp = document.getElementById('confirm_mdp');
    const errorDiv = document.getElementById('mdp-error');

    function verifierMdpCorrespondance() {
        if (nouveauMdp.value && confirmMdp.value && nouveauMdp.value !== confirmMdp.value) {
            confirmMdp.classList.add('is-invalid');
            errorDiv.style.display = 'block';
            return false;
        } else {
            confirmMdp.classList.remove('is-invalid');
            errorDiv.style.display = 'none';
            return true;
        }
    }

    confirmMdp.addEventListener('input', verifierMdpCorrespondance);
    nouveauMdp.addEventListener('input', verifierMdpCorrespondance);

    form.addEventListener('submit', function(e) {
        if (!verifierMdpCorrespondance()) {
            e.preventDefault();
            confirmMdp.focus();
        }
    });
});
</script>
{% endblock %}
